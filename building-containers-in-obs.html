<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Everything that you never wanted to know about building containers in OBS</title>
<meta name="author" content="Dan Čermák"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="./node_modules/reveal.js/dist/reveal.css"/>

<link rel="stylesheet" href="./node_modules/reveal.js/dist/theme/simple.css" id="theme"/>

<link rel="stylesheet" href="./node_modules/@fortawesome/fontawesome-free/css/all.min.css"/>

<link rel="stylesheet" href="./custom-style.css"/>
<link rel="stylesheet" href="./node_modules/reveal.js/plugin/highlight/zenburn.css"/>
<!-- If the query includes 'print-pdf', include the PDF print sheet -->
<script>
    if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = './node_modules/reveal.js/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
    }
</script>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide"><h2 class="title">Everything that you never wanted to know about building containers in OBS</h2>
<p class="subtitle" style="color: Gray;"></p>
<p class="author">Dan Čermák</p>
<div style="float:left"><a href="https://events.opensuse.org/conferences/oSC23/" target="_blank"><img src="./media/oSC_city_design.svg" height="50px"/></a></div>
<div style="float:right;font-size:35px;"><p xmlns:dct="http://purl.org/dc/terms/" xmlns:cc="http://creativecommons.org/ns#"><a href="https://creativecommons.org/licenses/by/4.0" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">
CC BY 4.0 <i class="fab fa-creative-commons"></i> <i class="fab fa-creative-commons-by"></i></a></p></div>
</section>
<section>
<section id="slide-org6b12ac5">
<h2 id="org6b12ac5">who -u</h2>
<p>
Dan Čermák
</p>

<p>
 <div style="float:center">
 <table class="who-table">
 <tr><td><i class="fab fa-suse"></i></td><td> Software Developer @SUSE, BCI Release Engineer</td></tr>
 <tr><td><i class="fab fa-fedora"></i></td><td> i3 SIG, Package maintainer</td></tr>
 <tr><td><i class="far fa-heart"></i></td><td> Developer Tools, Testing and Documentation, Home Automation</td></tr>
 <tr></tr>
 <tr></tr>
 <tr><td><i class="fa-solid fa-globe"></i></td><td> <a href="https://dancermak.name/">https://dancermak.name</a></td></tr>
 <tr><td><i class="fab fa-github"></i></td><td> <a href="https://github.com/dcermak/">dcermak</a></td></tr>
 <tr><td><i class="fab fa-mastodon"></i></td><td> <a href="https://mastodon.social/@Defolos">@Defolos@mastodon.social</a></td></tr>
 </table>
 </div>
</p>
</section>
</section>
<section>
<section id="slide-org512bd49">
<h2 id="org512bd49">Agenda</h2>
<ul>
<li><a href="#/slide-org68b9a37">So you want to build containers?</a></li>
<li><a href="#/slide-orged25a25">Everything 🤞 that you need to know</a></li>
<li><a href="#/slide-org7e1319c">"Everything" that you did not want to know</a></li>
<li><a href="#/slide-org2b6986b">Demo!</a></li>
<li><a href="#/slide-org314baf4">Questions?</a></li>

</ul>
</section>
</section>
<section>
<section id="slide-org68b9a37">
<h2 id="org68b9a37">So you want to build containers?</h2>
<p>
Why use OBS?
</p>

<ul>
<li class="fragment appear">automated rebuilds</li>
<li class="fragment appear">automatic publishing</li>
<li class="fragment appear">create official openSUSE/SLE image</li>
<li class="fragment appear">create tiny images without (😱 horrible) hacks</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgf061b44">
<h2 id="orgf061b44">Available Tools</h2>
<ol>
<li class="fragment appear">Docker &amp; Podman/Buildah</li>
<li class="fragment appear"><a href="https://github.com/OSInside/kiwi">Kiwi</a></li>

</ol>
</section>
<section id="slide-orge860b0a">
<h3 id="orge860b0a">When to use which?</h3>
<ul>
<li class="fragment appear">whatever you are familiar with</li>
<li class="fragment appear">🤔 undecided? &rarr; <code>docker</code> / <code>podman</code></li>
<li class="fragment appear"><i class="fa-solid fa-minimize"></i> tiny image? &rarr; <code>kiwi</code></li>

</ul>
</section>
<section id="slide-org6599294">
<h3 id="org6599294">When not to use OBS</h3>
<ul>
<li class="fragment appear">not using <code>zypper</code>, <code>dnf</code> or <code>apt</code></li>
<li class="fragment appear">complex <code>Dockerfile</code>, <code>curl</code>-ing from the www</li>
<li class="fragment appear">require previous releases to be available</li>
<li class="fragment appear">very unfamiliar with OBS</li>

</ul>
</section>
</section>
<section>
<section id="slide-orged25a25">
<h2 id="orged25a25">Minimal Docker Example</h2>
<div class="outline-text-2" id="text-orged25a25">
</div>
</section>
<section id="slide-orgc574145">
<h3 id="orgc574145">Repository Setup</h3>
<p>
from <a href="https://build.opensuse.org/projects/devel:BCI:Tumbleweed/meta"><code>devel:BCI:Tumbleweed</code></a>:
</p>
<div class="org-src-container">

<pre  class="fragment (appear)"  ><code class="xml" data-line-numbers='|1-12|2-7|8-11|14-21|15-16|17-20|'>  &lt;repository name="standard"&gt;
    &lt;path project="openSUSE:Factory" repository="images"/&gt;
    &lt;path project="openSUSE:Factory:ARM" repository="images"/&gt;
    &lt;path project="openSUSE:Factory:ARM" repository="standard"/&gt;
    &lt;path project="openSUSE:Factory:PowerPC" repository="standard"/&gt;
    &lt;path project="openSUSE:Factory:zSystems" repository="standard"/&gt;
    &lt;path project="openSUSE:Factory" repository="snapshot"/&gt;
    &lt;arch&gt;x86_64&lt;/arch&gt;
    &lt;arch&gt;aarch64&lt;/arch&gt;
    &lt;arch&gt;s390x&lt;/arch&gt;
    &lt;arch&gt;ppc64le&lt;/arch&gt;
  &lt;/repository&gt;
  &lt;!-- snip --&gt;
  &lt;repository name="containerfile"&gt;
    &lt;path project="$THIS_PROJECT" repository="images"/&gt;
    &lt;path project="$THIS_PROJECT" repository="standard"/&gt;
    &lt;arch&gt;x86_64&lt;/arch&gt;
    &lt;arch&gt;aarch64&lt;/arch&gt;
    &lt;arch&gt;s390x&lt;/arch&gt;
    &lt;arch&gt;ppc64le&lt;/arch&gt;
  &lt;/repository&gt;
&lt;/repository&gt;
</code></pre>
</div>

</section>
<section id="slide-orgc574145-split">
<p>
based on <a href="https://build.opensuse.org/project/show/openSUSE:Templates:Images:Tumbleweed"><code>openSUSE:Templates:Images:Tumbleweed</code></a>:
</p>
<div class="org-src-container">

<pre  class="fragment (appear)"  ><code class="xml" data-line-numbers='|3-5|6-8|9-11|12-15|'>&lt;project name="$basename:Images:Tumbleweed"&gt;
  &lt;!-- snip --&gt;
  &lt;repository name="containers_s390x" rebuild="local"&gt;
    &lt;path project="openSUSE:Templates:Images:Tumbleweed" repository="containers_s390x"/&gt;
  &lt;/repository&gt;
  &lt;repository name="containers_ppc" rebuild="local"&gt;
    &lt;path project="openSUSE:Templates:Images:Tumbleweed" repository="containers_ppc"/&gt;
  &lt;/repository&gt;
  &lt;repository name="containers_arm" rebuild="local"&gt;
    &lt;path project="openSUSE:Templates:Images:Tumbleweed" repository="containers_arm"/&gt;
  &lt;/repository&gt;
  &lt;repository name="containers" rebuild="local"&gt;
    &lt;path project="openSUSE:Templates:Images:Tumbleweed" repository="containers"/&gt;
    &lt;arch&gt;x86_64&lt;/arch&gt;
  &lt;/repository&gt;
&lt;/project&gt;
</code></pre>
</div>
</section>
<section id="slide-org3c6b623">
<h3 id="org3c6b623"><code>prjconf</code></h3>
<pre  class="example" >
%if %_repository == "containerfile"
Type: docker
# optional:
BuildEngine: podman
%endif
</pre>
</section>
<section id="slide-org20e5d5d">
<h3 id="org20e5d5d"><code>Dockerfile</code></h3>
<aside class="notes">
<ul>
<li>no full url in <code>FROM</code> &rArr; use build tag</li>

</ul>

</aside>

<div class="org-src-container">

<pre   ><code class="Dockerfile" data-line-numbers='|1|2|3|'>FROM opensuse/tumbleweed:latest
#!BuildTag: opensuse/git:latest
RUN zypper -n in git
CMD ["/usr/bin/git"]
</code></pre>
</div>
</section>
<section id="slide-org87bb4bd">
<h3 id="org87bb4bd"><code>Dockerfile</code> peculiarities</h3>
<ul>
<li class="fragment appear"><b>no</b> network access</li>
<li class="fragment appear">all layers squashed</li>
<li class="fragment appear">installs &amp; removes <a href="https://github.com/openSUSE/obs-build/blob/master/obs-docker-support"><code>obs-docker-support</code></a></li>
<li class="fragment appear"><code>USER</code> <b>must</b> be <code>root</code></li>
<li class="fragment appear">all zypper/dnf calls must be in <code>Dockerfile</code></li>

</ul>
</section>
</section>
<section>
<section id="slide-orgb064766">
<h2 id="orgb064766">Kiwi example</h2>
<aside class="notes">
<ul>
<li><code>from</code> line: <code>#</code> instead of <code>:</code>, <code>obsrepositories</code> takes container from repos</li>

</ul>

</aside>

<div class="org-src-container">

<pre   ><code class="xml" data-line-numbers='|1-2|4-15|5-6|7-11|8|9|10|11|14|'>&lt;image schemaversion="6.5" name="$name-image"
       xmlns:suse_label_helper="com.suse.label_helper"&gt;
  &lt;!-- snip --&gt;
  &lt;preferences&gt;
    &lt;type image="docker"
          derived_from="obsrepositories:/suse/sle15#15.3"&gt;
      &lt;containerconfig
          name="bci/ruby"
          tag="2.5"
          maintainer="SUSE LLC (https://www.suse.com/)"
          additionaltags="2.5-%RELEASE%,2,2-%RELEASE%"&gt;
      &lt;/containerconfig&gt;
    &lt;/type&gt;
    &lt;version&gt;15.3.0&lt;/version&gt;
  &lt;/preferences&gt;
  &lt;!-- snip --&gt;
&lt;/image&gt;
</code></pre>
</div>
</section>
<section id="slide-orgd28df37">
<h3 id="orgd28df37">Repository setup</h3>
<p>
based on <a href="https://build.opensuse.org/projects/devel:BCI:Tumbleweed/meta"><code>devel:BCI:Tumbleweed</code></a>:
</p>
<div class="org-src-container">

<pre   ><code class="xml" data-line-numbers='|1-12|1|2-7|8-11|13-20|13|14-15|16-19|'>&lt;repository name="standard"&gt;
  &lt;path project="openSUSE:Factory" repository="images"/&gt;
  &lt;path project="openSUSE:Factory:ARM" repository="images"/&gt;
  &lt;path project="openSUSE:Factory:ARM" repository="standard"/&gt;
  &lt;path project="openSUSE:Factory:PowerPC" repository="standard"/&gt;
  &lt;path project="openSUSE:Factory:zSystems" repository="standard"/&gt;
  &lt;path project="openSUSE:Factory" repository="snapshot"/&gt;
  &lt;arch&gt;x86_64&lt;/arch&gt;
  &lt;arch&gt;aarch64&lt;/arch&gt;
  &lt;arch&gt;s390x&lt;/arch&gt;
  &lt;arch&gt;ppc64le&lt;/arch&gt;
&lt;/repository&gt;
&lt;repository name="images"&gt;
  &lt;path project="devel:BCI:Tumbleweed" repository="containerfile"/&gt;
  &lt;path project="devel:BCI:Tumbleweed" repository="standard"/&gt;
  &lt;arch&gt;x86_64&lt;/arch&gt;
  &lt;arch&gt;aarch64&lt;/arch&gt;
  &lt;arch&gt;s390x&lt;/arch&gt;
  &lt;arch&gt;ppc64le&lt;/arch&gt;
&lt;/repository&gt;
</code></pre>
</div>

</section>
<section id="slide-orgd28df37-split">
<p>
based on <a href="https://build.opensuse.org/project/show/openSUSE:Templates:Images:Tumbleweed"><code>openSUSE:Templates:Images:Tumbleweed</code></a>:
</p>
<div class="org-src-container">

<pre   ><code class="xml" data-line-numbers='|1|3-5|6-8|9-11|12-15|'>&lt;project name="$prefix:Images:Tumbleweed"&gt;
  &lt;!-- snip --&gt;
  &lt;repository name="images_s390x" rebuild="local"&gt;
    &lt;path project="openSUSE:Templates:Images:Tumbleweed" repository="images_s390x"/&gt;
  &lt;/repository&gt;
  &lt;repository name="images_ppc" rebuild="local"&gt;
    &lt;path project="openSUSE:Templates:Images:Tumbleweed" repository="images_ppc"/&gt;
  &lt;/repository&gt;
  &lt;repository name="images_arm" rebuild="local"&gt;
    &lt;path project="openSUSE:Templates:Images:Tumbleweed" repository="images_arm"/&gt;
  &lt;/repository&gt;
  &lt;repository name="images" rebuild="local"&gt;
    &lt;path project="openSUSE:Containers:Tumbleweed" repository="containers"/&gt;
    &lt;arch&gt;x86_64&lt;/arch&gt;
  &lt;/repository&gt;
&lt;/project&gt;
</code></pre>
</div>
</section>
<section id="slide-org2182403">
<h3 id="org2182403"><code>prjconf</code></h3>
<pre  class="example" >
%if "%_repository" == "images"
Type: kiwi
Repotype: none
Patterntype: none
%endif
</pre>
</section>
</section>
<section>
<section id="slide-orgb78c4b9">
<h2 id="orgb78c4b9">Registry Frontend</h2>
<p class="fragment (appear)">
 <img src="./media/openSUSE_Registry.png" height="400px"/>
</p>

<p class="fragment (appear)">
registry.opensuse.org/ + <code>${prj_name/:/\/}.lower()</code> + <code>/$REPO/$BUILD_TAG</code>
</p>
</section>
</section>
<section>
<section id="slide-orgd924589">
<h2 id="orgd924589">Tagging Images</h2>
<div class="org-src-container">

<pre   ><code class="bash" >docker build -t my/prefix:1.5 -t my/prefix:latest .
</code></pre>
</div>

<p data-fragment-index="2" class="fragment appear">
<code>Dockerfile</code>:
</p>
<div class="org-src-container">

<pre  class="fragment appear" data-fragment-index="2"  ><code class="Dockerfile" >#!BuildTag: my/prefix:1.5
#!BuildTag: my/prefix:latest
</code></pre>
</div>

<p data-fragment-index="3" class="fragment appear">
kiwi xml:
</p>
<div class="org-src-container">

<pre  class="fragment appear" data-fragment-index="3"  ><code class="xml" >&lt;!-- OBS-AddTag: my/prefix:1.5 my/prefix:latest --&gt;
&lt;!-- snip --&gt;
      &lt;containerconfig
          name="my/prefix"
          tag="1.5"
          additionaltags="latest"&gt;
      &lt;/containerconfig&gt;
&lt;!--snip--&gt;
</code></pre>
</div>
</section>
</section>
<section>
<section id="slide-org35469dd">
<h2 id="org35469dd">Local Testing</h2>
<div class="org-src-container">

<pre   ><code class="bash" data-line-numbers='1|1-4|6|6-12|10-12|14'>❯ osc build --clean images
# *snip*
/var/tmp/build-root/images-x86_64/usr/src/packages/KIWI/registry-image.x86_64-2023-Build.docker.tar
/var/tmp/build-root/images-x86_64/usr/src/packages/KIWI/registry-image.x86_64-2023-Build.docker.tar.sha256

❯ podman load -i /var/tmp/build-root/images-x86_64/usr/src/packages/KIWI/registry-image.x86_64-2023-Build.docker.tar
Getting image source signatures
# *snip*
Storing signatures
Loaded image: docker.io/opensuse/registry:2.8
Loaded image: docker.io/opensuse/registry:2.8-
Loaded image: docker.io/opensuse/registry:latest

❯ podman run --rm -it docker.io/opensuse/registry:2.8
</code></pre>
</div>
</section>
</section>
<section>
<section id="slide-org7e1319c">
<h2 id="org7e1319c">Multi-Arch</h2>
<ul>
<li data-fragment-index="1" class="fragment appear">one <code>Dockerfile</code> for <b>all</b> architectures</li>
<li data-fragment-index="2" class="fragment appear">exclude/build only on architectures:</li>

</ul>
<div class="org-src-container">

<pre  class="fragment appear" data-fragment-index="2"  ><code class="Dockerfile" >#!ExclusiveArch: x86_64 aarch64
#!ExcludeArch: s390x ppc64le
</code></pre>
</div>

<ul data-fragment-index="3" class="fragment appear">
<li>add tricks like:</li>

</ul>
<div class="org-src-container">

<pre  class="fragment appear" data-fragment-index="3"  ><code class="Dockerfile" >RUN [ $(uname -m) = "x86_64" ] &amp;&amp; zypper -n in amd64-only-pkg
</code></pre>
</div>

<ul data-fragment-index="4" class="fragment appear">
<li>exclude/include lines for <b>scheduler</b>:</li>

</ul>
<div class="org-src-container">

<pre  class="fragment appear" data-fragment-index="4"  ><code class="Dockerfile" >#!ArchExclusiveLine x86_64
RUN [ $(uname -m) = "x86_64" ] &amp;&amp; zypper -n in amd64-only-pkg
#!ArchExcludedLine x86_64
RUN [ $(uname -m) = "x86_64" ] || zypper -n in non-amd64-pkg
</code></pre>
</div>
</section>
</section>
<section>
<section id="slide-org4776dc7">
<h2 id="org4776dc7">Building against a Registry</h2>
<ul class="fragment appear">
<li>create the registry as a <code>dod</code> project/repository (e.g. <a href="https://build.opensuse.org/project/show/SUSE:Registry"><code>SUSE:Registry</code></a>):</li>

</ul>
<div class="org-src-container">

<pre  class="fragment appear"  ><code class="xml" data-line-numbers='1|3|4-9|5-7|8|'>&lt;project name="home:$username:registry"&gt;
  &lt;!-- snip --&gt;
  &lt;publish&gt;&lt;disable/&gt;&lt;/publish&gt;
  &lt;repository name="standard"&gt;
    &lt;download arch="x86_64"
              url="https://registry.suse.com"
              repotype="registry"/&gt;
    &lt;arch&gt;x86_64&lt;/arch&gt;
  &lt;/repository&gt;
&lt;/project&gt;
</code></pre>
</div>

</section>
<section id="slide-org4776dc7-split">
<ul>
<li>Add it to your project <code>_meta</code>:</li>

</ul>
<div class="org-src-container">

<pre  class="fragment appear"  ><code class="xml" data-line-numbers='1|3-8|4-5|6|7-8|3-9'>&lt;project name="home:$username:containers"&gt;
  &lt;!-- snip --&gt;
  &lt;repository name="standard"&gt;
    &lt;path project="home:$username:registry"
          repository="standard"/&gt;
    &lt;!-- additional paths --&gt;
    &lt;arch&gt;x86_64&lt;/arch&gt;
    &lt;arch&gt;aarch64&lt;/arch&gt;
  &lt;/repository&gt;
&lt;/project&gt;
</code></pre>
</div>
</section>
<section id="slide-orgc35e73a">
<h3 id="orgc35e73a"><code>have choice for</code></h3>
<div class="org-src-container">

<pre  class="fragment appear" data-fragment-index="1"  ><code class="bash" >❯ osc buildinfo -d $prj $pkg containers x86_64|grep container
undecided about (direct):container:bci/openjdk:11:
    container:bci-openjdk-11@devel:BCI:SLE-15-SP4/containerfile
    container:bci_openjdk:11@SUSE:Registry/standard
</code></pre>
</div>

<div class="org-src-container">

<pre  class="fragment appear" data-fragment-index="2"  ><code class="rpm" >Prefer: -container:bci_openjdk:11
# or
Prefer: -container:bci-openjdk-11
</code></pre>
</div>
</section>
</section>
<section>
<section id="slide-orgf064e86">
<h2 id="orgf064e86">Helper services</h2>
<div class="org-src-container">

<pre  class="fragment (appear)" data-fragment-index="1"  ><code class="Dockerfile" >RUN curl -f https://path/to/binary.tar.gz -o binary.tar.gz
</code></pre>
</div>

<p data-fragment-index="2" class="fragment (appear)">
replace with:
</p>
<div class="org-src-container">

<pre  class="fragment (appear)" data-fragment-index="2"  ><code class="Dockerfile" >#!RemoteAssetUrl: https://path/to/binary.tar.gz
COPY binary.tar.gz .
</code></pre>
</div>

<p data-fragment-index="3" class="fragment (appear)">
or
</p>
<div class="org-src-container">

<pre  class="fragment (appear)" data-fragment-index="3"  ><code class="xml" >&lt;!-- OBS-RemoteAsset: https://path/to/binary.tar.gz --&gt;
</code></pre>
</div>

<p data-fragment-index="4" class="fragment (appear)">
<a href="http://opensuse.github.io/obs-build/pbuild.html#_remote_assets" data-fragment-index="4" class="fragment (appear)">remote assets documentation</a>
</p>
</section>
</section>
<section>
<section id="slide-org6b4b2d2">
<h2 id="org6b4b2d2"><code>replace_using_package_version</code></h2>
<p data-fragment-index="1" class="fragment (appear)">
tag &amp; set env vars from package versions
</p>

<p data-fragment-index="2" class="fragment (appear)">
source:  <i class="fa-brands fa-github"></i> <a href="https://github.com/openSUSE/obs-service-replace_using_package_version" data-fragment-index="2" class="fragment (appear)"><code>openSUSE/obs-service-replace_using_package_version</code></a>
</p>

<div class="org-src-container">

<pre  class="fragment (appear)" data-fragment-index="3"  ><code class="Dockerfile" >#!BuildTag: opensuse/389-ds:%%389ds_version%%
</code></pre>
</div>

<div class="org-src-container">

<pre  class="fragment (appear)" data-fragment-index="4"  ><code class="xml" data-line-numbers='|2-3|4|5|6|7|'>&lt;services&gt;
  &lt;service name="replace_using_package_version"
           mode="buildtime"&gt;
    &lt;param name="file"&gt;Dockerfile&lt;/param&gt;
    &lt;param name="regex"&gt;%%389ds_version%%&lt;/param&gt;
    &lt;param name="package"&gt;389-ds&lt;/param&gt;
    &lt;param name="parse-version"&gt;minor&lt;/param&gt;
  &lt;/service&gt;
&lt;/services&gt;
</code></pre>
</div>
</section>
</section>
<section>
<section id="slide-orgb4346ee">
<h2 id="orgb4346ee"><code>metainfo_helper</code></h2>
<ul>
<li data-fragment-index="1" class="fragment appear">source: <a href="https://build.opensuse.org/package/view_file/openSUSE:Tools/obs-service-kiwi_metainfo_helper/README?expand=1"><code>kiwi_metainfo_helper</code></a></li>
<li data-fragment-index="2" class="fragment appear"><code>%RELEASE%</code> &rArr; <code>&lt;cicnt\&gt;.&lt;bldcnt\&gt;</code></li>
<li data-fragment-index="3" class="fragment appear"><code>%OS_VERSION%</code> &rArr; from <code>/etc/os-release</code></li>
<li data-fragment-index="4" class="fragment appear">replaces in build recipe (<code>kiwi.xml</code>, <code>Dockerfile</code>, <code>Chart.yaml</code>)</li>

</ul>

<div class="org-src-container">

<pre  class="fragment (appear)" data-fragment-index="5"  ><code class="Dockerfile" >#!BuildTag: bci/bci-init:%OS_VERSION_ID_SP%
LABEL org.opencontainers.image.created="%BUILDTIME%"
LABEL org.opencontainers.image.source="%SOURCEURL%"
LABEL org.opensuse.reference="registry.suse.com/bci/bci-init:%OS_VERSION_ID_SP%.%RELEASE%"
LABEL org.openbuildservice.disturl="%DISTURL%"
</code></pre>
</div>
</section>
</section>
<section>
<section id="slide-orga2564d8">
<h2 id="orga2564d8"><code>replace_using_env</code></h2>
<ul>
<li data-fragment-index="1" class="fragment appear">replaces <code>%%VARNAME%%</code> with <code>$VARNAME</code> from the build environment</li>
<li data-fragment-index="2" class="fragment appear">can run scripts before the build (&rarr; to set the <code>env</code>)</li>

</ul>

<div class="org-src-container">

<pre  class="fragment (appear)" data-fragment-index="3"  ><code class="Dockerfile" >#!BuildTag: opensuse/virt-operator:%%PKG_VERSION%%-%%PKG_RELEASE%%
ENV KUBEVIRT_VERSION=%%PKG_VERSION%%
</code></pre>
</div>

<div class="org-src-container">

<pre  class="fragment (appear)" data-fragment-index="4"  ><code class="xml" >&lt;services&gt;
  &lt;service mode="buildtime" name="replace_using_env"&gt;
    &lt;param name="file"&gt;Dockerfile&lt;/param&gt;
    &lt;param name="var"&gt;PKG_VERSION&lt;/param&gt;
    &lt;param name="var"&gt;TAGPREFIX&lt;/param&gt;
    &lt;param name="eval"&gt;/path/to/my/script/here&lt;/param&gt;
  &lt;/service&gt;
&lt;/services&gt;
</code></pre>
</div>

<ul>
<li data-fragment-index="5" class="fragment appear"><i class="fa-regular fa-lightbulb"></i>: anything from <code>_prjconf</code> can be evaluated via <code>rpm -E %macro</code></li>

</ul>
</section>
</section>
<section>
<section id="slide-orgaa96799">
<h2 id="orgaa96799">Labels</h2>
<ul>
<li class="fragment appear">key-value metadata for a container image</li>
<li class="fragment appear">pre-defined keys: <a href="https://github.com/opencontainers/image-spec/blob/main/annotations.md#pre-defined-annotation-keys"><code>org.opencontainers.image.**</code></a></li>
<li class="fragment appear">openSUSE <a href="https://en.opensuse.org/Building_derived_containers#Labels">label rules</a></li>
<li class="fragment appear">labels of the base image get overwritten</li>

</ul>


</section>
<section id="slide-orgaa96799-split">

<p data-fragment-index="1" class="fragment (appear)">
preserve <code>LABEL</code> them using <a href="https://build.opensuse.org/package/view_file/openSUSE:Factory/obs-service-kiwi_label_helper/README?expand=1" data-fragment-index="1" class="fragment (appear)"><code>kiwi_label_helper</code></a>:
</p>

<div class="org-src-container">

<pre  class="fragment (appear)" data-fragment-index="2"  ><code class="xml" >&lt;labels&gt;
  &lt;suse_label_helper:add_prefix prefix="org.opensuse.tiny"&gt;
    &lt;label name="org.opencontainers.image.title"
           value="openSUSE Leap Base Container"/&gt;
  &lt;/suse_label_helper:add_prefix&gt;
&lt;/labels&gt;
</code></pre>
</div>

<p data-fragment-index="3" class="fragment (appear)">
or <a href="https://build.opensuse.org/package/view_file/openSUSE:Factory/obs-service-docker_label_helper/README?expand=1" data-fragment-index="3" class="fragment (appear)"><code>docker_label_helper</code></a>:
</p>
<div class="org-src-container">

<pre  class="fragment (appear)" data-fragment-index="3"  ><code class="Dockerfile" ># labelprefix=org.opensuse.tiny
LABEL org.opencontainers.image.title=openSUSE Leap Base Container"
# endlabelprefix
</code></pre>
</div>

<p data-fragment-index="4" class="fragment (appear)">
expands to:
</p>
<div class="org-src-container">

<pre  class="fragment (appear)" data-fragment-index="4"  ><code class="json" >"Labels": {
  "org.opencontainers.image.title": "openSUSE Leap Base Container",
  "org.opensuse.tiny.title": "openSUSE Leap Base Container"
}
</code></pre>
</div>
</section>
</section>
<section>
<section id="slide-org7e6d4cd">
<h2 id="org7e6d4cd">Build Arguments</h2>
<div class="org-src-container">

<pre  class="fragment (appear)" data-fragment-index="1"  ><code class="Dockerfile" >ARG VERSION
ARG DEFAULT_USER=me
</code></pre>
</div>

<div class="org-src-container">

<pre  class="fragment (appear)" data-fragment-index="2"  ><code class="bash" >buildah bud --build-arg="VERSION=1.4.2" .
docker build --build-arg="VERSION=1.4.2" .
</code></pre>
</div>

<p data-fragment-index="4" class="fragment (appear)">
<code>osc meta prjconf</code>
</p>
<div class="org-src-container">

<pre  class="fragment (appear)" data-fragment-index="4"  ><code class="Dockerfile" >BuildFlags: dockerarg:VERSION=1.4.2
</code></pre>
</div>
</section>
</section>
<section>
<section id="slide-orgc0a3477">
<h2 id="orgc0a3477">Even more 🧙🪄?</h2>
<aside class="notes">
<p>
<a href="https://github.com/openSUSE/obs-build/issues/562">https://github.com/openSUSE/obs-build/issues/562</a>
</p>

</aside>

<div class="org-src-container">

<pre  class="fragment (appear)"  ><code class="Dockerfile" data-line-numbers='1|2|3'>#!BuildName: NAME
#!BuildVersion: VERSION
#!NoSquash
</code></pre>
</div>

<pre  class="fragment (appear)" >
ExpandFlags: kiwi-nobasepackages
</pre>
</section>
</section>
<section>
<section id="slide-org5ca99e9">
<h2 id="org5ca99e9">Keeping multiple versions around</h2>
<p>
 <img src="./media/persist_releases.svg"/>
</p>

</section>
<section id="slide-org5ca99e9-split">

<p>
rebuild repository:
</p>
<div class="org-src-container">

<pre   ><code class="xml" data-line-numbers='1|3-4|3-8'>&lt;project name=":Rebuild"&gt;
  &lt;!-- snip --&gt;
  &lt;repository name="images"&gt;
    &lt;releasetarget project=":Release" repository="containers" trigger="manual"/&gt;
    &lt;!-- ordinary paths here --&gt;
    &lt;arch&gt;x86_64&lt;/arch&gt;
    &lt;arch&gt;aarch64&lt;/arch&gt;
  &lt;/repository&gt;
&lt;/project&gt;
</code></pre>
</div>

</section>
<section id="slide-org5ca99e9-split">

<p>
release repository:
</p>
<div class="org-src-container">

<pre   ><code class="xml" data-line-numbers='1|3|4|5-9'>&lt;project name=":Release" kind="maintenance_release"&gt;
  &lt;!-- snip --&gt;
  &lt;build&gt;&lt;disable/&gt;&lt;/build&gt;
  &lt;publish&gt;&lt;enable/&gt;&lt;/publish&gt;
  &lt;repository name="containers"&gt;
    &lt;path project="openSUSE:Tumbleweed" repository="standard"/&gt;
    &lt;arch&gt;x86_64&lt;/arch&gt;
    &lt;arch&gt;aarch64&lt;/arch&gt;
  &lt;/repository&gt;
&lt;/project&gt;
</code></pre>
</div>

</section>
<section id="slide-org5ca99e9-split">
<aside class="notes">
<ul>
<li>beware, publishing can take ages, check <code>osc api /build//:Release/_result</code></li>

</ul>

</aside>
<p>
release:
</p>
<div class="org-src-container">

<pre   ><code class="bash" >osc release :Rebuild $image_name
</code></pre>
</div>
</section>
</section>
<section>
<section id="slide-org3beec2c">
<h2 id="org3beec2c">What else is there?</h2>
<ul>
<li class="fragment appear"><a href="https://opensuse.github.io/obs-build/pbuild.html#_remote_assets"><code>pbuild</code></a></li>
<li class="fragment appear"><a href="https://openbuildservice.org/help/manuals/obs-user-guide/cha.obs.scm_ci_workflow_integration.html">SCM CI integration</a></li>
<li class="fragment appear"><a href="https://rabbit.opensuse.org/">rabbit.opensuse.org</a></li>

</ul>
</section>
</section>
<section>
<section id="slide-org2b6986b">
<h2 id="org2b6986b">Demo!</h2>
<p class="fragment (appear)">
What would you like to see?
</p>
</section>
</section>
<section>
<section id="slide-org314baf4">
<h2 id="org314baf4">Questions?</h2>
<p class="fragment (appear)">
Answers!
</p>
</section>
</section>
</div>
</div>
<script src="./node_modules/reveal.js/dist/reveal.js"></script>
<script src="./node_modules/reveal.js/plugin/highlight/highlight.js"></script>
<script src="./node_modules/reveal.js/plugin/notes/notes.js"></script>


<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({
plugins: [RevealHighlight, RevealNotes, history],
transition: 'none', hash: true
});

</script>
</body>
</html>
